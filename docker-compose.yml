version: '3.8'
services:
  wordpress:
    build: .
    ports:
      - "80:80"
    env_file: .env
    environment:
      WORDPRESS_DB_HOST: ${DB_HOST}
      WORDPRESS_DB_NAME: ${DB_NAME}
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        /* 這裡的 $ 都要改成 $$，Docker 才不會誤認 */
        $$protocol = 'http';
        if (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
            $$_SERVER['HTTPS'] = 'on';
            $$protocol = 'https';
        }
        define('WP_HOME', $$protocol . '://' . $$_SERVER['HTTP_HOST']);
        define('WP_SITEURL', $$protocol . '://' . $$_SERVER['HTTP_HOST']);

        if (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
            define('FORCE_SSL_ADMIN', true);
        }
    volumes:
      # 將本地開發的 wp-content 映射進容器
      - ./wp-content:/var/www/html/wp-content
    restart: always
